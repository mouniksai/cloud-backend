// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 1. Govt Registry (Updated with Constituency)
model GovtRegistry {
  citizenId    String   @id @unique @map("citizen_id") @db.VarChar(12)
  fullName     String   @map("full_name") @db.VarChar(100)
  dob          DateTime @db.Date
  state        String?  @db.VarChar(50)
  
  // NEW: Location data for election mapping
  constituency String   @default("General") @db.VarChar(100) 
  ward         String   @default("Ward A") @db.VarChar(100)

  gender       String?  @db.VarChar(10)
  email        String   @unique @db.VarChar(100)
  mobile       String   @unique @db.VarChar(15)
  photoUrl     String?  @map("photo_url")
  isRegistered Boolean  @default(false) @map("is_registered")

  User User?
  @@map("govt_registry")
}

// 2. User Table
model User {
  userId       String   @id @default(uuid()) @map("user_id") @db.Uuid
  username     String   @unique @db.VarChar(50)
  passwordHash String   @map("password_hash")
  role         String   @default("voter") @db.VarChar(20) // 'voter' or 'admin'
  createdAt    DateTime @default(now()) @map("created_at")

  // MFA Fields
  otpCode      String?  @map("otp_code")
  otpExpiresAt DateTime? @map("otp_expires_at")

  citizenId    String       @unique @map("citizen_id")
  citizen      GovtRegistry @relation(fields: [citizenId], references: [citizenId])

  AuditLogs    AuditLog[]   // Relation to logs

  @@map("users")
}

// 3. NEW: Election Table
model Election {
  id            String   @id @default(uuid())
  title         String
  description   String
  constituency  String   // Only voters in this constituency see this election
  startTime     DateTime @map("start_time")
  endTime       DateTime @map("end_time")
  status        String   @default("UPCOMING") // UPCOMING, LIVE, ENDED
  createdAt     DateTime @default(now())

  @@map("elections")
}



model AuditLog {
  id        String   @id @default(uuid())
  
  // FIX IS HERE: Added @db.Uuid to match the User table
  userId    String   @map("user_id") @db.Uuid 
  
  action    String   // e.g., "CREATED_ELECTION", "VIEWED_DASHBOARD"
  details   String?
  ipAddress String?  @map("ip_address")
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [userId])

  @@map("audit_logs")
}